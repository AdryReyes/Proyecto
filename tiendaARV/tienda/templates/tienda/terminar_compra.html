{% extends 'tienda/base.html' %}

{% block content %}
<h1>Finalizar Compra</h1>

<form method="POST">
    {% csrf_token %}

    <!-- Selección de cuenta de pago -->
    <label for="cuenta_pago">Método de Pago</label>
    <select name="cuenta_pago" id="cuenta_pago" required>
        {% if cuentas %}
            {% for cuenta in cuentas %}
                <option value="{{ cuenta.id }}">
                    {{ cuenta.tipo }} - {{ cuenta.numero|slice:-4 }} (Saldo: {{ cuenta.saldo|floatformat:2 }} €)
                </option>
            {% endfor %}
        {% else %}
            <option disabled>No tienes cuentas de pago registradas</option>
        {% endif %}
    </select>

    <!-- Dirección de envío -->
    <label for="direccion">Dirección de Envío</label>
    <select name="direccion" id="direccion" required>
        {% if direcciones %}
            {% for direccion in direcciones %}
                <option value="{{ direccion.id }}">{{ direccion.calle }}, {{ direccion.ciudad }}</option>
            {% endfor %}
        {% else %}
            <option disabled>No hay direcciones disponibles</option>
        {% endif %}
    </select>

    <!-- Producto ID y cantidad -->
    <input type="hidden" name="producto_id" value="{{ producto.id }}">
    <input type="hidden" name="cantidad" value="1">

    <!-- Botón de envío -->
    {% if cuentas and direcciones %}
    <form method="POST">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit">Finalizar Compra</button>
    </form>
    
    {% else %}
        <p style="color: red;">
            No puedes proceder con la compra. Asegúrate de tener una cuenta de pago y una dirección configurada.
        </p>
    {% endif %}
</form>

<!-- Enlace para añadir nueva cuenta -->
<p>
    <a href="{% url 'gestionar_cuentas' %}">Añadir una nueva cuenta de pago</a>
</p>

{% endblock %}
